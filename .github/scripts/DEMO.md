# GitHub Copilot Model Sync Demo

This directory contains a demonstration of the automated model syncing workflow that keeps the extension's model data up-to-date with GitHub Copilot's supported models.

> ðŸ“‹ **Quick Reference**: For a quick overview of the workflow, see [QUICK-REFERENCE.md](QUICK-REFERENCE.md)

## Overview

The `check-models.yml` workflow automatically:
1. **Scrapes** GitHub's Copilot documentation for supported models
2. **Compares** scraped models with local configuration files
3. **Updates** missing models with sensible defaults
4. **Creates** a pull request with the changes

This demo simulates that process in a safe, local environment.

## Running the Demo

```bash
cd .github/scripts
bash demo-sync-models.sh
```

## What the Demo Shows

### Step 1: Sample Data Creation
The demo creates a simulated list of scraped models, including two fictional "demo-model-new-1" and "demo-model-new-2" to demonstrate the addition of new models.

### Step 2: Current State Analysis
Counts the existing models in:
- `src/tokenEstimators.json` - Character-to-token ratio estimators
- `src/modelPricing.json` - Pricing data (cost per million tokens)

### Step 3: Gap Analysis
Identifies which models from the scraped list are missing from each configuration file.

### Step 4: Automatic Updates
Adds missing models with default values:
- **Token Estimators**: 0.25 ratio (4 characters per token) for GPT-family models
- **Model Pricing**: $0.00 placeholder costs that require manual verification

### Step 5: Change Visualization
Shows `diff` output to visualize what changed in each file.

### Step 6: Validation
Verifies that the updated JSON files are syntactically valid and properly formatted.

### Step 7: Cleanup
Restores the original files (the demo doesn't modify your actual configuration).

## Real Workflow Features

The production workflow (`check-models.yml`) includes additional capabilities:

### Automated Scheduling
```yaml
schedule:
  - cron: '11 17 * * 1'  # Every Monday at 5:11 PM UTC
```

### Web Scraping
Uses Puppeteer to extract model names from the official [GitHub Copilot documentation](https://docs.github.com/en/copilot/reference/ai-models/supported-models).

See `scrape-models.js` for the implementation.

### GitHub Copilot CLI Integration
The workflow uses `@github/copilot` CLI to intelligently update the JSON files:
```bash
copilot -p "$(cat prompts/sync-models-prompt.md)" --silent --allow-all
```

The prompt is defined in `.github/workflows/prompts/sync-models-prompt.md` and provides detailed instructions on:
- How to add missing models
- Default values to use
- JSON formatting requirements
- Metadata updates

### Automated PR Creation
When changes are detected, the workflow creates a pull request using `peter-evans/create-pull-request`:
- **Branch**: `sync-copilot-models`
- **Labels**: `autogenerated`, `maintenance`
- **Body**: Includes warnings about pricing verification needed

### Manual Trigger
You can also run the workflow manually:
```bash
gh workflow run check-models.yml
```

## File Structure

```
.github/
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ demo-sync-models.sh    # This demo script
â”‚   â”œâ”€â”€ scrape-models.js        # Production web scraper
â”‚   â”œâ”€â”€ scrape-models.sh        # Legacy shell-based scraper
â”‚   â”œâ”€â”€ package.json            # Dependencies (puppeteer)
â”‚   â””â”€â”€ DEMO.md                 # This file
â””â”€â”€ workflows/
    â”œâ”€â”€ check-models.yml        # Main workflow definition
    â””â”€â”€ prompts/
        â””â”€â”€ sync-models-prompt.md  # Instructions for Copilot CLI
```

## Configuration Files Updated

### `src/tokenEstimators.json`
Contains character-to-token ratios used to estimate token counts from text length.

**Default values:**
- GPT models: `0.25` (4 chars/token)
- Claude models: `0.24`
- Gemini models: `0.25`

**Format:**
```json
{
  "estimators": {
    "model-name": 0.25
  }
}
```

### `src/modelPricing.json`
Contains pricing data for cost estimation.

**Default values for new models:**
```json
{
  "model-name": {
    "inputCostPerMillion": 0.00,
    "outputCostPerMillion": 0.00,
    "category": "Model category",
    "tier": "standard",
    "multiplier": 1
  }
}
```

**Note**: Pricing values of `0.00` indicate that manual verification is needed. The PR will include a warning about this.

## Troubleshooting

### Demo doesn't run
Ensure you have Node.js installed and are in the repository root:
```bash
node --version  # Should be v20.x or later
cd /path/to/github-copilot-token-usage
bash .github/scripts/demo-sync-models.sh
```

### Scraper fails in production
The scraper requires network access to GitHub's documentation. In CI environments with strict SSL requirements, you may need to configure certificates.

The workflow includes error handling and will upload artifacts even if scraping fails:
```yaml
- name: Upload scraped data as artifact
  uses: actions/upload-artifact@v6
  with:
    name: scraped-data
    path: |
      .github/scripts/scraped-models.json
      .github/scripts/scraper.log
```

## Security Considerations

### Harden Runner
The workflow uses `step-security/harden-runner` to audit all outbound network calls.

### Minimal Permissions
The workflow runs with minimal required permissions:
```yaml
permissions:
  contents: write        # For creating branches
  pull-requests: write   # For creating PRs
```

### Authentication
Uses a GitHub PAT (`GH_PAT` secret) with appropriate scopes for the Copilot CLI.

## Maintenance

### Updating the Scraper
If GitHub changes their documentation structure, you may need to update the selectors in `scrape-models.js`:

```javascript
// Current selector logic
const targetHeading = headings.find(h => 
  h.textContent.trim().includes('Supported AI models in Copilot')
);
```

### Updating the Prompt
The Copilot CLI prompt can be tuned in `.github/workflows/prompts/sync-models-prompt.md` to:
- Change default values
- Add more sophisticated model categorization
- Include additional metadata

### Testing Changes
Before modifying the production workflow:
1. Test locally with the demo script
2. Make changes to the scraper or prompt
3. Run the demo again to verify behavior
4. Test in a feature branch with `workflow_dispatch` trigger

## Contributing

When adding new features to the sync workflow:
1. Update the demo script to reflect new behavior
2. Update this README with new steps
3. Test the demo thoroughly
4. Ensure the production workflow includes the same logic

## Related Documentation

- [GitHub Copilot Supported Models](https://docs.github.com/en/copilot/reference/ai-models/supported-models)
- [Token Estimators README](../../src/README.md)
- [Extension Contributing Guide](../../CONTRIBUTING.md)

name: Check for Copilot Model Updates

on:
  workflow_dispatch:
  push:
    paths:
        - .github/workflows/check-models.yml       
  schedule:
    - cron: '11 17 * * 1' # Run every Monday at 5:11 PM UTC

jobs:
  check-models:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch documentation page
        id: fetch_docs
        run: |
          # Install puppeteer for browser-based scraping
          npm install puppeteer
          
          # Create a Node.js script to scrape the page with JavaScript rendering
          cat > scrape.js << 'SCRAPE_EOF'
          const puppeteer = require('puppeteer');
          
          (async () => {
            try {
              const browser = await puppeteer.launch({ 
                headless: 'new', 
                args: ['--no-sandbox', '--disable-setuid-sandbox'] 
              });
              const page = await browser.newPage();
              
              console.error('Navigating to page...');
              await page.goto('https://docs.github.com/en/copilot/reference/ai-models/supported-models', {
                waitUntil: 'networkidle0',
                timeout: 60000
              });
              
              console.error('Waiting for content to load...');
              await page.waitForTimeout(5000);
              
              // Extract model names from the tables
              const models = await page.evaluate(() => {
                const modelNames = [];
                
                // Find all tables on the page
                const tables = document.querySelectorAll('table');
                console.error(`Found ${tables.length} tables`);
                
                tables.forEach((table, tableIndex) => {
                  const rows = table.querySelectorAll('tbody tr');
                  console.error(`Table ${tableIndex}: Found ${rows.length} rows`);
                  
                  rows.forEach((row, rowIndex) => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length > 0) {
                      // Get text from first cell and clean it
                      let text = cells[0].textContent.trim();
                      console.error(`Table ${tableIndex}, Row ${rowIndex}: "${text}"`);
                      
                      if (text && text.length > 0) {
                        modelNames.push(text);
                      }
                    }
                  });
                });
                
                // Remove duplicates
                return [...new Set(modelNames)];
              });
              
              console.error(`Extracted ${models.length} unique models`);
              console.log(JSON.stringify(models));
              await browser.close();
            } catch (error) {
              console.error('Error:', error.message);
              process.exit(1);
            }
          })();
          SCRAPE_EOF
          
          # Run the script and capture output
          MODELS_JSON=$(node scrape.js 2>&1 | tee /dev/stderr | tail -n 1)
          echo "Scraped models JSON: $MODELS_JSON"
          
          # Store the models, one per line
          echo "$MODELS_JSON" | jq -r '.[]' > models.txt
          echo "Models extracted:"
          cat models.txt

      - name: List available models from GitHub Models API
        id: list_models
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          # Get list of available models from GitHub Models API
          MODELS_CATALOG=$(curl -L -s \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://models.github.ai/catalog/models)
          
          echo "Available models in GitHub Models API:"
          echo "$MODELS_CATALOG" | jq -r '.[].id'

      - name: Extract models from scraped data
        id: fetch_models
        run: |
          # Read the models from the file created by the scraping step
          if [ ! -f models.txt ]; then
            echo "Error: models.txt not found"
            exit 1
          fi
          
          MODELS=$(cat models.txt | sort -u)
          
          echo "Fetched Models:"
          echo "$MODELS"
          
          if [ -z "$MODELS" ]; then
            echo "Error: No models extracted"
            exit 1
          fi
          
          # Store models as a multiline output
          {
            echo "models_list<<EOF"
            echo "$MODELS"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Check for missing models
        id: check_missing
        env:
          FETCHED_MODELS: ${{ steps.fetch_models.outputs.models_list }}
        run: |
          # Load models from local JSON files
          ESTIMATOR_MODELS=$(jq -r '.estimators | keys[]' src/tokenEstimators.json | sort -u)
          PRICING_MODELS=$(jq -r '.pricing | keys[]' src/modelPricing.json | sort -u)

          echo "Models in tokenEstimators.json:"
          echo "$ESTIMATOR_MODELS"
          echo "Models in modelPricing.json:"
          echo "$PRICING_MODELS"

          MISSING_ESTIMATORS=""
          for model in $FETCHED_MODELS; do
            if ! echo "$ESTIMATOR_MODELS" | grep -q "^${model}$"; then
              MISSING_ESTIMATORS="$MISSING_ESTIMATORS\n- $model"
            fi
          done

          MISSING_PRICING=""
          for model in $FETCHED_MODELS; do
            if ! echo "$PRICING_MODELS" | grep -q "^${model}$"; then
              MISSING_PRICING="$MISSING_PRICING\n- $model"
            fi
          done

          ISSUE_BODY=""
          NEEDS_UPDATE="false"

          if [ -n "$MISSING_ESTIMATORS" ]; then
            NEEDS_UPDATE="true"
            ISSUE_BODY="$ISSUE_BODY### ðŸš¨ Missing Models in \`tokenEstimators.json\`\nThe following models are listed in the GitHub Copilot documentation but are missing from \`src/tokenEstimators.json\`:\n$MISSING_ESTIMATORS\n\n"
          fi

          if [ -n "$MISSING_PRICING" ]; then
            NEEDS_UPDATE="true"
            ISSUE_BODY="$ISSUE_BODY### ðŸ’° Missing Models in \`modelPricing.json\`\nThe following models are listed in the GitHub Copilot documentation but are missing from \`src/modelPricing.json\`:\n$MISSING_PRICING\n\n"
          fi

          if [ "$NEEDS_UPDATE" = "true" ]; then
            ISSUE_BODY="$ISSUE_BODY**Action Required:**\nPlease update the JSON configuration files with the latest models.\n\n**Source:** [GitHub Copilot Supported Models](https://docs.github.com/en/copilot/reference/ai-models/supported-models)"
            echo "needs_update=true" >> $GITHUB_OUTPUT
            # Use a heredoc to handle multiline body
            echo "issue_body<<EOF" >> $GITHUB_OUTPUT
            echo -e "$ISSUE_BODY" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "needs_update=false" >> $GITHUB_OUTPUT
            echo "âœ… All models are up-to-date."
          fi

      - name: Create GitHub Issue if models are missing
        if: steps.check_missing.outputs.needs_update == 'true'
        uses: actions/github-script@v7
        env:
          ISSUE_BODY: ${{ steps.check_missing.outputs.issue_body }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueBody = process.env.ISSUE_BODY;
            const { owner, repo } = context.repo;

            // Check if a similar open issue already exists
            const { data: issues } = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: 'open',
              labels: 'maintenance',
              creator: 'github-actions[bot]'
            });

            const title = 'ðŸ¤– Action Required: Update Copilot Supported Models';
            const existingIssue = issues.find(issue => issue.title === title);

            if (existingIssue) {
              console.log(`An open issue with the title "${title}" already exists. Skipping creation.`);
            } else {
              await github.rest.issues.create({
                owner,
                repo,
                title: title,
                body: issueBody,
                labels: ['maintenance', 'autogenerated']
              });
              console.log('Created a new GitHub issue for missing models.');
            }

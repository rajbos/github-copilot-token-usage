name: Check for Copilot Model Updates

on:
  workflow_dispatch:
  push:
    paths:
        - .github/workflows/check-models.yml
        - .github/scripts/scrape-models.sh
        - src/tokenEstimators.json
        - src/modelPricing.json
        
  schedule:
    - cron: '11 17 * * 1' # Run every Monday at 5:11 PM UTC

permissions:
  contents: read

jobs:
  check-models:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
      id-token: write

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Fetch documentation page
        id: fetch_docs
        run: |
          echo "Installing scraper dependencies..."
          pushd .github/scripts
          npm ci
          echo "Running Node.js scraper..."
          npm run scrape
          popd

      - name: Upload scraped data as artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: scraped-data
          path: |
            .github/scripts/scraped-models.json
            .github/scripts/models.txt
            .github/scripts/page-content.html
            .github/scripts/scraper.log

      - name: Extract models from scraped data
        id: fetch_models
        run: |
          # Read the models from the file created by the scraping step
          if [ ! -f .github/scripts/models.txt ]; then
            echo "Error: models.txt not found"
            exit 1
          fi
          
          MODELS=$(cat .github/scripts/models.txt | sort -u)
          
          echo "=== Scraped Models from Documentation ==="
          echo "$MODELS"
          echo ""
          echo "Count: $(echo "$MODELS" | wc -l) models"
          echo ""
          
          if [ -z "$MODELS" ]; then
            echo "Error: No models extracted"
            exit 1
          fi
          
          # Store models as a multiline output
          {
            echo "models_list<<EOF"
            echo "$MODELS"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Check for missing models
        id: check_missing
        env:
          FETCHED_MODELS: ${{ steps.fetch_models.outputs.models_list }}
        run: |
          # Load models from local JSON files
          ESTIMATOR_MODELS=$(jq -r '.estimators | keys[]' src/tokenEstimators.json | sort -u)
          PRICING_MODELS=$(jq -r '.pricing | keys[]' src/modelPricing.json | sort -u)

          echo "Models in tokenEstimators.json:"
          echo "$ESTIMATOR_MODELS"
          echo "Models in modelPricing.json:"
          echo "$PRICING_MODELS"

          MISSING_ESTIMATORS=""
          for model in $FETCHED_MODELS; do
            if ! echo "$ESTIMATOR_MODELS" | grep -q "^${model}$"; then
              MISSING_ESTIMATORS="$MISSING_ESTIMATORS\n- $model"
            fi
          done

          MISSING_PRICING=""
          for model in $FETCHED_MODELS; do
            if ! echo "$PRICING_MODELS" | grep -q "^${model}$"; then
              MISSING_PRICING="$MISSING_PRICING\n- $model"
            fi
          done

          ISSUE_BODY=""
          NEEDS_UPDATE="false"

          if [ -n "$MISSING_ESTIMATORS" ]; then
            NEEDS_UPDATE="true"
            ISSUE_BODY="$ISSUE_BODY### ðŸš¨ Missing Models in \`tokenEstimators.json\`\nThe following models are listed in the GitHub Copilot documentation but are missing from \`src/tokenEstimators.json\`:\n$MISSING_ESTIMATORS\n\n"
          fi

          if [ -n "$MISSING_PRICING" ]; then
            NEEDS_UPDATE="true"
            ISSUE_BODY="$ISSUE_BODY### ðŸ’° Missing Models in \`modelPricing.json\`\nThe following models are listed in the GitHub Copilot documentation but are missing from \`src/modelPricing.json\`:\n$MISSING_PRICING\n\n"
          fi

          if [ "$NEEDS_UPDATE" = "true" ]; then
            ISSUE_BODY="$ISSUE_BODY**Action Required:**\nPlease update the JSON configuration files with the latest models.\n\n**Source:** [GitHub Copilot Supported Models](https://docs.github.com/en/copilot/reference/ai-models/supported-models)"
            echo "needs_update=true" >> $GITHUB_OUTPUT
            # Use a heredoc to handle multiline body
            echo "issue_body<<EOF" >> $GITHUB_OUTPUT
            echo -e "$ISSUE_BODY" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            
            # Create step summary
            echo "## âš ï¸ Missing Models Detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ -n "$MISSING_ESTIMATORS" ]; then
              echo "### ðŸš¨ Missing in \`tokenEstimators.json\`" >> $GITHUB_STEP_SUMMARY
              echo -e "$MISSING_ESTIMATORS" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            if [ -n "$MISSING_PRICING" ]; then
              echo "### ðŸ’° Missing in \`modelPricing.json\`" >> $GITHUB_STEP_SUMMARY
              echo -e "$MISSING_PRICING" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            echo "**Action Required:** Update the JSON configuration files with the latest models." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "[View Documentation](https://docs.github.com/en/copilot/reference/ai-models/supported-models)" >> $GITHUB_STEP_SUMMARY
          else
            echo "needs_update=false" >> $GITHUB_OUTPUT
            echo "âœ… All models are up-to-date."
            
            # Create step summary
            echo "## âœ… All Models Up-to-Date" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All models from the documentation are present in both:" >> $GITHUB_STEP_SUMMARY
            echo "- \`tokenEstimators.json\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`modelPricing.json\`" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Create GitHub Issue if models are missing
        if: steps.check_missing.outputs.needs_update == 'true'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          ISSUE_BODY: ${{ steps.check_missing.outputs.issue_body }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueBody = process.env.ISSUE_BODY;
            const { owner, repo } = context.repo;

            // Check if a similar open issue already exists
            const { data: issues } = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: 'open',
              labels: 'maintenance',
              creator: 'github-actions[bot]'
            });

            const title = 'ðŸ¤– Action Required: Update Copilot Supported Models';
            const existingIssue = issues.find(issue => issue.title === title);

            if (existingIssue) {
              console.log(`An open issue with the title "${title}" already exists. Skipping creation.`);
            } else {
              await github.rest.issues.create({
                owner,
                repo,
                title: title,
                body: issueBody,
                labels: ['maintenance', 'autogenerated']
              });
              console.log('Created a new GitHub issue for missing models.');
            }

      - name: Close GitHub Issue if all models are up-to-date
        if: steps.check_missing.outputs.needs_update == 'false'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;

            // Find open issues with the specific title and labels
            const { data: issues } = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: 'open',
              labels: 'maintenance',
              creator: 'github-actions[bot]'
            });

            const title = 'ðŸ¤– Action Required: Update Copilot Supported Models';
            const existingIssue = issues.find(issue => issue.title === title);

            if (existingIssue) {
              // Close the issue with a comment
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: existingIssue.number,
                body: 'âœ… All Copilot models are now up-to-date. All models from the [GitHub Copilot documentation](https://docs.github.com/en/copilot/reference/ai-models/supported-models) are present in both `tokenEstimators.json` and `modelPricing.json`.\n\nClosing this issue automatically.'
              });

              await github.rest.issues.update({
                owner,
                repo,
                issue_number: existingIssue.number,
                state: 'closed'
              });

              console.log(`Closed issue #${existingIssue.number} as all models are now up-to-date.`);
            } else {
              console.log('No open issue found to close. All models are already up-to-date.');
            }

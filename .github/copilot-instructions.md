# GitHub Copilot Token Tracker Extension Instructions

This document provides instructions for AI agents to effectively contribute to the "Copilot Token Tracker" VS Code extension.

## Architecture Overview

The entire extension's logic is contained within the `CopilotTokenTracker` class in `src/extension.ts`. Its primary function is to track GitHub Copilot token usage by reading and parsing session log files.

- **Activation**: The extension activates on VS Code startup via the `onStartupFinished` event in `package.json`. The `activate` function in `src/extension.ts` instantiates `CopilotTokenTracker`.

- **Data Source**: The core data comes from `.json` log files generated by the GitHub Copilot Chat extension. The `getCopilotSessionFiles` method locates these files in the user's OS-specific AppData directory for VS Code (e.g., `.../Code/User/workspaceStorage/.../chatSessions` and `.../Code/User/globalStorage/emptyWindowChatSessions`).

- **Data Flow**:
  1. A timer in the `constructor` calls `updateTokenStats()` every 5 minutes.
  2. `updateTokenStats()` calls `calculateDetailedStats()` to aggregate data.
  3. `calculateDetailedStats()` reads all session files found by `getCopilotSessionFiles()`.
  4. For each file, it calculates token counts (`estimateTokensFromSession`), interactions (`countInteractionsInSession`), and per-model usage (`getModelUsageFromSession`).
  5. Token counts are *estimated* using character-to-token ratios defined in the `tokenEstimators` class property. This is a key convention.

- **UI Components**:
  1. **Status Bar**: A `vscode.StatusBarItem` (`statusBarItem`) shows a brief summary. Its tooltip provides more detail.
  2. **Details Panel**: The `copilot-token-tracker.showDetails` command opens a `vscode.WebviewPanel`. The content for this panel is generated dynamically as an HTML string by the `getDetailsHtml` method.

## Developer Workflow

- **Setup**: Run `npm install` to install dependencies.
- **Build**: Run `npm run compile` to lint and build the extension using `esbuild`. The output is a single file: `dist/extension.js`.
- **Watch Mode**: For active development, use `npm run watch`. This will automatically recompile the extension on file changes.
- **Testing/Debugging**: Press `F5` in VS Code to open the Extension Development Host. This will launch a new VS Code window with the extension running. `console.log` statements from `src/extension.ts` will appear in the Developer Tools console of this new window (Help > Toggle Developer Tools).

## Key Files & Conventions

- **`src/extension.ts`**: The single source file containing all logic.
  - `CopilotTokenTracker`: The main class.
  - `calculateDetailedStats()`: The primary data aggregation method.
  - `getDetailsHtml()`: The method responsible for rendering the webview's HTML content. All styling is inlined within this method's template string.
  - `tokenEstimators`: A critical class property. To add or modify token calculation for a model, this object must be updated.
- **`package.json`**: Defines activation events, commands, and build scripts.
- **`esbuild.js`**: The build script that bundles the TypeScript source.
# GitHub Copilot Token Tracker Extension Instructions

This document provides instructions for AI agents to effectively contribute to the "Copilot Token Tracker" VS Code extension.

## Architecture Overview

The entire extension's logic is contained within the `CopilotTokenTracker` class in `src/extension.ts`. Its primary function is to track GitHub Copilot token usage by reading and parsing session log files.

- **Activation**: The extension activates on VS Code startup via the `onStartupFinished` event in `package.json`. The `activate` function in `src/extension.ts` instantiates `CopilotTokenTracker`.

- **Data Source**: The core data comes from `.json` log files generated by the GitHub Copilot Chat extension. The `getCopilotSessionFiles` method locates these files in the user's OS-specific AppData directory for VS Code (e.g., `.../Code/User/workspaceStorage/.../chatSessions` and `.../Code/User/globalStorage/emptyWindowChatSessions`).

- **Data Flow**:
  1. A timer in the `constructor` calls `updateTokenStats()` every 5 minutes.
  2. `updateTokenStats()` calls `calculateDetailedStats()` to aggregate data.
  3. `calculateDetailedStats()` reads all session files found by `getCopilotSessionFiles()`.
  4. For each file, it calculates token counts (`estimateTokensFromSession`), interactions (`countInteractionsInSession`), and per-model usage (`getModelUsageFromSession`).
  5. Token counts are *estimated* using character-to-token ratios defined in the `tokenEstimators` class property. This is a key convention.

- **UI Components**:
  1. **Status Bar**: A `vscode.StatusBarItem` (`statusBarItem`) shows a brief summary. Its tooltip provides more detail.
  2. **Details Panel**: The `copilot-token-tracker.showDetails` command opens a `vscode.WebviewPanel`. The content for this panel is generated dynamically as an HTML string by the `getDetailsHtml` method.

## Developer Workflow

- **Setup**: Run `npm install` to install dependencies.
- **Build**: Run `npm run compile` to lint and build the extension using `esbuild`. The output is a single file: `dist/extension.js`.
- **Watch Mode**: For active development, use `npm run watch`. This will automatically recompile the extension on file changes.
- **Testing/Debugging**: Press `F5` in VS Code to open the Extension Development Host. This will launch a new VS Code window with the extension running. `console.log` statements from `src/extension.ts` will appear in the Developer Tools console of this new window (Help > Toggle Developer Tools).

**Important build guidance:** After making changes to source code or related files (TypeScript, JavaScript, JSON, or other code files used by the extension), always run `npm run compile` to validate that the project still builds and lints cleanly before opening a pull request or releasing. You do not need to run the full compile step for documentation-only changes (Markdown files), but you should run it after any edits that touch source, configuration, or JSON data files.

## Development Guidelines

- **Minimal Changes**: Only modify files that are directly needed for the actual changes being implemented. Avoid touching unrelated files, configuration files, or dependencies unless absolutely necessary for the feature or fix.
- **Focused Modifications**: Make surgical, precise changes that address the specific requirements without affecting other functionality.
- **Preserve Existing Structure**: Maintain the existing code organization and file structure. Don't refactor or reorganize code unless it's essential for the task.

## Logging Best Practices

**CRITICAL**: Do NOT add debug logging statements like `this.log('[DEBUG] message')` or `console.log('[DEBUG] ...')` for troubleshooting during development. This approach has been found to flood the output channel and cause messages to disappear.

### Why DEBUG Logs Are Problematic

**Extension Host Flooding**: When DEBUG log statements are added to frequently-called methods in `extension.ts` (e.g., cache lookups, file processing loops, webview message handlers), they can generate hundreds of log entries per operation. VS Code's OutputChannel has a buffer limit, and excessive logging causes older messages to be pushed out and lost. This was observed when:
- Cache hit/miss logging was added to session file processing
- JSONL content reference counting was logged for each file
- Webview message handlers logged every incoming message with full JSON payloads
- Session data was logged with repository counts on each webview update

**Symptom**: After operations like clearing the cache, expected log messages would disappear from the Output panel because they were pushed out of the buffer by DEBUG logs.

### Extension vs Webview Logging

These are two completely separate logging systems:

| Context | Method | Destination | Visibility |
|---------|--------|-------------|------------|
| Extension (`src/extension.ts`) | `this.log()`, `this.warn()`, `this.error()` | VS Code Output Channel | Output panel â†’ "Copilot Token Tracker" |
| Webview (`src/webview/*/main.ts`) | `console.log()` | Browser DevTools | Help â†’ Toggle Developer Tools in webview |

- Clearing the output channel (`outputChannel.clear()`) does NOT affect webview console logs
- Webview console.log statements do NOT appear in the Output panel
- DEBUG prefixes in webviews were removed to maintain consistency with extension guidelines

### Best Practices

- **Use Existing Logs**: The extension already has comprehensive logging. Review existing log statements before adding new ones.
- **Minimal Logging**: Only add logging if absolutely necessary for a new feature. Keep messages concise.
- **Remove Debug Logs**: Any temporary debug logging added during development MUST be removed before committing.
- **Log Methods**: Use appropriate severity:
  - `log(message)` - Standard informational messages
  - `warn(message)` - Warnings or recoverable errors
  - `error(message)` - Critical errors
- **No Debug Prefixes**: Avoid `[DEBUG]` markers. The log output is already timestamped.
- **Avoid High-Frequency Logging**: Never log inside loops that process many items (files, sessions, cache entries).

### Debugging Without Logs

Prefer VS Code's debugger with breakpoints rather than adding log statements:
1. Press `F5` to launch Extension Development Host
2. Set breakpoints in `src/extension.ts`
3. Use the Debug Console to inspect variables

## Key Files & Conventions

- **`src/extension.ts`**: The single source file containing all logic.
  - `CopilotTokenTracker`: The main class.
  - `calculateDetailedStats()`: The primary data aggregation method.
  - `getDetailsHtml()`: The method responsible for rendering the webview's HTML content. All styling is inlined within this method's template string.
- **`src/README.md`**: **IMPORTANT**: Contains detailed instructions for updating the JSON data files. Always consult this file when updating tokenEstimators.json or modelPricing.json. It includes structure definitions, update procedures, and current pricing information.
- **`src/tokenEstimators.json`**: Character-to-token ratio estimators for different AI models. See `src/README.md` for update instructions.
- **`src/modelPricing.json`**: Model pricing data with input/output costs per million tokens. Includes metadata about pricing sources and last update date. See `src/README.md` for detailed update instructions and current pricing sources.
- **`package.json`**: Defines activation events, commands, and build scripts.
- **`esbuild.js`**: The build script that bundles the TypeScript source and JSON data files.

## Webview Navigation Buttons

To maintain a consistent, VS Code-native look across all webview panels (Details, Chart, Usage Analysis, Diagnostics), use the VS Code Webview UI Toolkit for top-level navigation buttons.

- **Use `vscode-button`**: Prefer the toolkit button component for header navigation controls instead of custom `<button>` elements. Example usage in a webview script:

  ```ts
  const { provideVSCodeDesignSystem, vsCodeButton } = await import('@vscode/webview-ui-toolkit');
  provideVSCodeDesignSystem().register(vsCodeButton());

  // then create buttons in the DOM:
  const btn = document.createElement('vscode-button');
  btn.id = 'btn-details';
  btn.textContent = 'ðŸ¤– Details';
  btn.setAttribute('appearance', 'primary');
  ```

- **Register the toolkit in each webview**: Each webview that uses `vscode-button` should import and register the toolkit in its `bootstrap()` or initialization function before rendering the layout.

- **Wire messages unchanged**: Buttons should `postMessage` the same navigation commands (`showDetails`, `showChart`, `showUsageAnalysis`, `showDiagnostics`, `refresh`) so the extension can reuse existing panels. Do not change the command names.

- **Checklist for PRs touching webviews**:
  - Ensure the toolkit is registered before creating `vscode-button` elements.
  - Keep navigation command names unchanged so `extension.ts` handlers continue to work.
  - Run `npm run compile` and verify TypeScript and ESLint pass.
  - Visually compare the header with the Details and other panels to confirm parity.
# Session File Schema Documentation

This directory contains documentation and analysis of GitHub Copilot session file schemas.

## Files

### session-file-schema.json
**Manually curated documentation** of the Copilot session file structure. This file describes:
- File locations and formats (.json and .jsonl)
- Complete schema for JSON session files
- Complete schema for JSONL session files (both Copilot CLI and VS Code Incremental formats)
- Links to official vscode-copilot-chat repository source code
- Which fields the extension actually uses
- Detailed descriptions and examples

This is the **primary reference** for understanding session file structure.

### session-file-schema-analysis.json
**Auto-generated analysis** from actual session files on disk. Generated by running:
```powershell
.\.github\skills\copilot-log-analysis\analyze-session-schema.ps1
```

Contains:
- All discovered field paths with types and examples
- Field occurrence counts
- Detection of new fields not in the manual documentation

## Session File Formats

The extension supports three distinct session file formats:

| Format | Extension | Location | Discriminator |
|--------|-----------|----------|---------------|
| **JSON** | `.json` | workspaceStorage, globalStorage | N/A (standard JSON) |
| **JSONL CLI** | `.jsonl` | `~/.copilot/session-state/` | `type` field (string) |
| **JSONL Incremental** | `.jsonl` | workspaceStorage (VS Code Insiders) | `kind` field (number) |

### JSONL Format Detection

When processing `.jsonl` files, the extension checks:
1. If lines have a `kind` field (number) → **VS Code Incremental format**
2. If lines have a `type` field (string) → **Copilot CLI format**

### VS Code Incremental Format (New in 2026)

VS Code Insiders introduced a new incremental JSONL format that stores session data as deltas:
- `kind: 0` - Session header with metadata
- `kind: 1` - Delete operation (rare)
- `kind: 2` - Insert/Update with request data

See `session-file-schema.json` → `jsonlIncrementalSchema` for full details.

## Official Source References


The session file schemas are defined in the following repositories:

- [vscode-copilot-chat](https://github.com/microsoft/vscode-copilot-chat):
  - [Chat Session Provider](https://github.com/microsoft/vscode-copilot-chat/blob/main/src/extension/vscode.proposed.chatSessionsProvider.d.ts) - Session metadata interfaces
  - [Edit Log Service](https://github.com/microsoft/vscode-copilot-chat/blob/main/src/platform/multiFileEdit/common/editLogService.ts) - Edit logging
  - [Session Content Builder](https://github.com/microsoft/vscode-copilot-chat/blob/main/src/extension/chatSessions/vscode-node/copilotCloudSessionContentBuilder.ts) - Streaming responses
  - [Workspace Recorder](https://github.com/microsoft/vscode-copilot-chat/blob/main/src/extension/workspaceRecorder/vscode-node/workspaceRecorder.ts) - JSONL logging
- [OpenCode](https://github.com/anomalyco/opencode):
  - OpenCode session log and database schema

## Updating the Schema

### When to Update

Run the analysis script periodically to detect schema changes:
- After GitHub Copilot updates
- When adding new features to the extension
- Monthly check for new fields

### How to Update

1. **Run the analysis script:**
   ```powershell
   .\.github\skills\copilot-log-analysis\analyze-session-schema.ps1 -MaxFiles 10
   ```

2. **Review new fields detected:**
   The script will highlight any new field paths found that aren't in `session-file-schema.json`

3. **Investigate new fields:**
   - Open `session-file-schema-analysis.json`
   - Look for new field paths in the `newFieldsDetected` section
   - Check the `fields` section for type and example values

4. **Update manual documentation:**
   - Add newly discovered fields to `session-file-schema.json`
   - Add descriptions and note whether the extension should use them
   - Update the version and lastUpdated date

5. **Consider extension updates:**
   - If new fields contain useful data (e.g., actual token counts), consider updating the extension to use them
   - Update the extension's parsing logic in `src/extension.ts`

## Script Parameters

The analysis script accepts several parameters:

```powershell
# Analyze more files for better coverage
.\.github\skills\copilot-log-analysis\analyze-session-schema.ps1 -MaxFiles 20

# Save to a different location
.\.github\skills\copilot-log-analysis\analyze-session-schema.ps1 -OutputFile "temp-analysis.json"

# Skip comparison with existing documentation
.\.github\skills\copilot-log-analysis\analyze-session-schema.ps1 -CompareWithExisting $false
```

## Reading the Analysis Output

The `session-file-schema-analysis.json` file contains:

```json
{
  "generatedAt": "timestamp",
  "filesAnalyzed": {
    "json": 6,
    "jsonl": 3
  },
  "newFieldsDetected": {
    "json": [...],   // New fields not in documentation
    "jsonl": [...]
  },
  "jsonFileSchema": {
    "totalFields": 35269,
    "fields": {
      "fieldPath": {
        "type": "string|number|boolean|array|object",
        "count": 10,        // How many times seen
        "examples": [...]   // Sample values
      }
    }
  },
  "jsonlFileSchema": { ... },
  "topLevelJsonFields": [...],
  "commonJsonlEventTypes": [...]
}
```

## Field Path Notation

- `fieldName` - Top-level field
- `parent.child` - Nested field
- `array[]` - Array items
- `array[].field` - Field in array items

Example: `requests[].response[].value` = the `value` field in items of the `response` array within items of the `requests` array.

## Common Tasks

### Find fields related to token counting
```powershell
$analysis = Get-Content docs\logFilesSchema\session-file-schema-analysis.json | ConvertFrom-Json
$analysis.jsonFileSchema.fields.PSObject.Properties | Where-Object { $_.Name -like "*token*" }
```

### Check what models are detected
```powershell
$analysis = Get-Content docs\logFilesSchema\session-file-schema-analysis.json | ConvertFrom-Json
$analysis.jsonFileSchema.fields.'result.details'.examples
```

### List all JSONL event types
```powershell
$analysis = Get-Content docs\logFilesSchema\session-file-schema-analysis.json | ConvertFrom-Json
$analysis.commonJsonlEventTypes
```

## Notes

- The analysis script only processes the first few items in large arrays to keep the output manageable
- Fields that appear infrequently might indicate optional fields or special scenarios
- JSONL files typically have fewer unique field paths because events share common structure
